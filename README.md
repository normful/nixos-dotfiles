# nixos-dotfiles

## Summary

This repository contains:

- Nix configuration (starting in [`flake.nix`](flake.nix)) for:
    - Linux [NixOS](https://nixos.org) machines running on [Google Cloud Platform](https://cloud.google.com) (GCP)
    - macOS machines configured with [nix-darwin](https://github.com/nix-darwin/nix-darwin)
- Infrastructure as Code in [Pulumi](https://www.pulumi.com) using the [TypeScript SDK](https://www.pulumi.com/docs/iac/languages-sdks/javascript/), for provisioning the GCP virtual machines, disks, networking, etc
    - NixOS is installed on GCP machines with [nixos-anywhere](https://github.com/nix-community/nixos-anywhere) over an SSH tunnel through Google Cloud's [Identity-Aware Proxy (IAP) TCP Forwarding](https://cloud.google.com/iap/docs/using-tcp-forwarding)
- Dotfiles managed by [chezmoi](https://www.chezmoi.io)
    - Neovim configuration using [lazy.nvim](https://github.com/folke/lazy.nvim) and [NvChad](https://github.com/NvChad/NvChad)
        - `lazy.nvim` loads plugin config from `~/.config/nvim/lua/plugins/*.lua` (which is generated by `chezmoi` from [`./chezmoi/dot_config/nviml/lua/plugins/*.lua`](chezmoi/dot_config/nvim/lua/plugins/))
        - Neovim `lazy` plugin config extends any config provided by [NvChad plugin config](https://github.com/NvChad/NvChad/tree/v2.5/lua/nvchad/plugins)

## Detailed explanation of key files and folders

In alphabetical order:

- `├──` [.sops.yaml](.sops.yaml) SOPS config: age keys + encryption rules
- `├──` [bun.lock](bun.lock) Bun lockfile for reproducible JS/TS deps
- `├──` [chezmoi/](chezmoi/) Dotfiles managed by chezmoi
- `│   ├──` [dot_local/](chezmoi/dot_local/)
- `│   │   └──` [bin/](chezmoi/dot_local/bin/) Personal scripts
- `│   ├──` [dot_cargo/](chezmoi/dot_cargo/) Cargo (Rust) config files
- `│   ├──` [dot_claude/](chezmoi/dot_claude/) Claude Code/editor integration settings
- `│   ├──` [dot_config/](chezmoi/dot_config/) App configs (fish, nvim, kitty, etc.)
- `│   │   ├──` [bat/](chezmoi/dot_config/bat/) bat (better cat) config
- `│   │   ├──` [fish/](chezmoi/dot_config/fish/) Fish shell config
- `│   │   ├──` [ghostty/](chezmoi/dot_config/ghostty/) Ghostty terminal config
- `│   │   ├──` [helix/](chezmoi/dot_config/helix/) Helix editor config
- `│   │   ├──` [htop/](chezmoi/dot_config/htop/) htop process monitor config
- `│   │   ├──` [kitty/](chezmoi/dot_config/kitty/) Kitty terminal config
- `│   │   ├──` [lftp/](chezmoi/dot_config/lftp/) lftp FTP client config
- `│   │   ├──` [nvim/](chezmoi/dot_config/nvim/) Neovim editor config
- `│   │   │   ├──` [lua/augroups.lua](chezmoi/dot_config/nvim/lua/augroups.lua) Neovim autocommand groups
- `│   │   │   ├──` [lua/chadrc.lua](chezmoi/dot_config/nvim/lua/chadrc.lua) NvChad configuration
- `│   │   │   ├──` [lua/lazy-config.lua](chezmoi/dot_config/nvim/lua/lazy-config.lua) Lazy.nvim plugin manager config
- `│   │   │   ├──` [lua/lsp-on-attach.lua](chezmoi/dot_config/nvim/lua/lsp-on-attach.lua) LSP client attachment handlers
- `│   │   │   ├──` [lua/mappings-helpers.lua](chezmoi/dot_config/nvim/lua/mappings-helpers.lua) Key mapping utility functions
- `│   │   │   ├──` [lua/mappings.lua](chezmoi/dot_config/nvim/lua/mappings.lua) Custom key bindings
- `│   │   │   ├──` [lua/neovide.lua](chezmoi/dot_config/nvim/lua/neovide.lua) Neovide GUI client config
- `│   │   │   ├──` [lua/options.lua](chezmoi/dot_config/nvim/lua/options.lua) Neovim options and settings
- `│   │   │   ├──` [lua/plugins/](chezmoi/dot_config/nvim/lua/plugins/) Plugin configurations (lazy.nvim format)
- `│   │   │   └──` [lua/user-commands.lua](chezmoi/dot_config/nvim/lua/user-commands.lua) Custom user commands
- `│   │   ├──` [procs/](chezmoi/dot_config/procs/) procs process viewer config
- `│   │   ├──` [wezterm/](chezmoi/dot_config/wezterm/) WezTerm terminal config
- `│   │   └──` [yazi/](chezmoi/dot_config/yazi/) Yazi file manager config
- `│   ├──` [dot_gitconfig](chezmoi/dot_gitconfig) Global Git configuration
- `│   ├──` [dot_gitignore_global](chezmoi/dot_gitignore_global) Global Git ignore patterns
- `│   └──` [dot_warp/](chezmoi/dot_warp/) Warp terminal themes, settings, workflows
- `├──` [CLAUDE.md](CLAUDE.md) Guidance for AI assistants working on this repo
- `├──` [flake.lock](flake.lock) Nix flake lock (pins inputs for reproducibility)
- `├──` [flake.nix](flake.nix) Main Nix flake (NixOS + macOS configs)
- `├──` [gcp/](gcp/) GCP infrastructure config, NixOS installer script, and NixOS config for GCP VM instances
- `│   ├──` [compute.ts](gcp/compute.ts) VM instances, disks, schedules, snapshots
- `│   ├──` [config.ts](gcp/config.ts) Parsing and validation of `Pulumi.<hostname>.yaml` files.
- `│   ├──` [coral/](gcp/coral/) Host config for 'coral' GCP VM
- `│   │   ├──` [configuration.nix](gcp/coral/configuration.nix) NixOS config importing shared modules
- `│   │   └──` [my-config.nix](gcp/coral/my-config.nix) Host-specific overrides (hostname, user, proj)
- `│   ├──` [example/](gcp/example/) Templates for new GCP VMs
- `│   │   ├──` [configuration.nix](gcp/example/configuration.nix) Template NixOS config
- `│   │   └──` [my-config.nix](gcp/example/my-config.nix) Template host config with placeholders
- `│   ├──` [firewall.ts](gcp/firewall.ts) Firewall rules (IAP SSH, tailscale, deny-all)
- `│   ├──` [iam.ts](gcp/iam.ts) IAM bindings for IAP and compute permissions
- `│   ├──` [index.ts](gcp/index.ts) Pulumi entrypoint exporting all resources/outputs
- `│   ├──` [install-nixos.sh](gcp/install-nixos.sh) NixOS install script that uses nixos-anywhere and GCP IAP SSH tunneling
- `│   ├──` [monitoring.ts](gcp/monitoring.ts) Logging metrics + alert policies
- `│   └──` [network.ts](gcp/network.ts) VPC, subnets, Cloud NAT, flow logs
- `├──` [GCP_USAGE.md](GCP_USAGE.md) Human guide for provisioning and operating GCP VMs
- `├──` [mac/](mac/) macOS (nix-darwin) configuration
- `│   └──` [cyan/](mac/cyan/) Host config for 'cyan' MacBook Pro
- `│       ├──` [configuration.nix](mac/cyan/configuration.nix) nix-darwin system configuration
- `│       └──` [packages.nix](mac/cyan/packages.nix) macOS package selections
- `├──` [mise.toml](mise.toml) mise tasks, tool versions, env vars
- `├──` [modules/](modules/) Shared NixOS modules used by hosts
- `│   ├──` [core.nix](modules/core.nix) Base system config + essential packages
- `│   ├──` [disko-partitions.nix](modules/disko-partitions.nix) Disk layout (EFI, swap, ext4 root) via disko
- `│   ├──` [golang.nix](modules/golang.nix) Golang dev environment module
- `│   ├──` [nh.nix](modules/nh.nix) NixOS Helper (nh) + build output tooling
- `│   ├──` [nix.nix](modules/nix.nix) Nix daemon, GC, substituters/caches
- `│   ├──` [openssh-server.nix](modules/openssh-server.nix) Hardened OpenSSH server configuration
- `│   ├──` [security.nix](modules/security.nix) Firewall, fail2ban, polkit rules
- `│   ├──` [tailscale.nix](modules/tailscale.nix) Tailscale VPN configuration
- `│   ├──` [user.nix](modules/user.nix) User accounts, SSH keys, shell, sudo
- `│   └──` [vector.nix](modules/vector.nix) Vector log agent → Google Cloud Logging
- `├──` [package.json](package.json) Package manifest for Pulumi TypeScript infrastructure code
- `├──` [packages/](packages/) Custom Nix packages (Nix derivations)
- `├──` [Pulumi.coral.yaml](Pulumi.coral.yaml) Pulumi stack config for 'coral' environment
- `├──` [Pulumi.example.yaml](Pulumi.example.yaml) Template Pulumi stack config for new VMs
- `├──` [Pulumi.yaml](Pulumi.yaml) Overall Pulumi project manifest
- `├──` [secrets/](secrets/) SOPS secrets encrypted with [age](https://github.com/FiloSottile/age)
- `│   ├──` [gcp_coral.yaml](secrets/gcp_coral.yaml) Secrets for 'coral' (password hashes, tailscale)
- `│   └──` [gcp_example.yaml](secrets/gcp_example.yaml) Template secrets for new VM stacks
- `├──` [stylua.toml](stylua.toml) StyLua formatter config (Lua files)
- `├──` [tests/](tests/) Test suites
- `│   └──` [gcp/](gcp/) Tests for [gcp/](gcp/)
- `│       └──` [install-nixos-test.sh](tests/gcp/install-nixos-test.sh) bashunit tests for [install-nixos.sh](gcp/install-nixos.sh)
- `└──` [tsconfig.json](tsconfig.json) TypeScript compiler configuration, used by Pulumi

## Documentation

Aside from this README.md, the other main docs are:
- [CLAUDE.md](CLAUDE.md): detailed instructions for AI coding agents to understand this repository. Humans may find it useful too
- [GCP_USAGE.md](GCP_USAGE.md): explains how to create a new Pulumi Stack and a set of GCP resources for a new GCP virtual machine running NixOS

# FAQs

## What are the hostnames of machines managed here?

- Currently, this repo contains config for:
    - A GCP VM named `coral` in [gcp/coral/configuration.nix](gcp/coral/configuration.nix)
    - A MacBook Pro named `cyan` in [mac/cyan/configuration.nix](mac/cyan/configuration.nix)

## Why don't you run NixOS in a VM on macOS?

I tried it already and didn't like it, Specifically, I tried running NixOS in a VM in VMWare Fusion and Parallels.

Although it worked, I realized that I prefer the simplicity of using nix-darwin on macOS. There seemed to be too many bugs and workarounds needed to make Parallels Tools or VMWare Tools properly.

## Why don't you use Home Manager?

[Home Manager](https://github.com/nix-community/home-manager) adds another layer of unnecessary complexity for me. I can't remember all of the Nix options specific to Home Manager. And althought I could, I just don't want to spend unnecessary time reading through the Nix configuration in Home Manager.

## Which terminal are you using?

I use all 3: WezTerm, kitty, Ghostty.

I configure them with nearly identical keymappings.

For most scenarios, any one of them is sufficient for me. But they each have some special strengths:

Kitty:
- smoothest inline image rendering, using its [graphics protocol](https://sw.kovidgoyal.net/kitty/graphics-protocol/), which I use with [image.nvim](https://github.com/3rd/image.nvim)
- [visual font selector](https://sw.kovidgoyal.net/kitty/kittens/choose-fonts/)

WezTerm:
- has the most features and special modes

Ghostty:
- no issues when SSH'ing into certain VMs

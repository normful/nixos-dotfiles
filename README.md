# nixos-dotfiles

## Summary

This repository contains:

- Nix configuration (starting in `flake.nix`) for:
    - Linux [NixOS](https://nixos.org) machines running on [Google Cloud Platform](https://cloud.google.com) (GCP)
    - macOS machines configured with [nix-darwin](https://github.com/nix-darwin/nix-darwin)
- Infrastructure as Code in [Pulumi](https://www.pulumi.com) using the [TypeScript SDK](https://www.pulumi.com/docs/iac/languages-sdks/javascript/), for provisioning the GCP virtual machines, disks, networking, etc
    - NixOS is installed on GCP machines with [nixos-anywhere](https://github.com/nix-community/nixos-anywhere) over an SSH tunnel through Google Cloud's [Identity-Aware Proxy (IAP) TCP Forwarding](https://cloud.google.com/iap/docs/using-tcp-forwarding)
- Dotfiles managed by [chezmoi](https://www.chezmoi.io)
    - Neovim configuration using [lazy.nvim](https://github.com/folke/lazy.nvim) and [NvChad](https://github.com/NvChad/NvChad)
        - `lazy.nvim` loads plugin config from `~/.config/nvim/lua/plugins/*.lua` (which is generated by `chezmoi` from `./chezmoi/dot_config/nviml/lua/plugins/*.lua`)
        - Neovim `lazy` plugin config extends any config provided by [NvChad plugin config](https://github.com/NvChad/NvChad/tree/v2.5/lua/nvchad/plugins)

## Detailed explanation of key files

Sorted alphabetically:
```
├── .sops.yaml                             # SOPS config: age keys + encryption rules
├── bun.lock                               # Bun lockfile for reproducible JS/TS deps
├── chezmoi/                               # Dotfiles managed by chezmoi
│   ├── bin/                               # Personal scripts (git helpers, media, misc.)
│   ├── dot_cargo/                         # Cargo (Rust) config files
│   ├── dot_claude/                        # Claude Code/editor integration settings
│   ├── dot_config/                        # App configs (fish, nvim, kitty, etc.)
│   ├── dot_gitconfig                      # Global Git configuration
│   ├── dot_gitignore_global               # Global Git ignore patterns
│   └── dot_warp/                          # Warp terminal themes, settings, workflows
├── CLAUDE.md                              # Guidance for AI assistants working on this repo
├── flake.lock                             # Nix flake lock (pins inputs for reproducibility)
├── flake.nix                              # Main Nix flake (NixOS + macOS configs)
├── gcp/                                   # GCP infrastructure and NixOS installer
│   ├── compute.ts                         # VM instances, disks, schedules, snapshots
│   ├── config.ts                          # Centralized config parsing + validation
│   ├── coral/                             # Host config for 'coral' GCP VM
│   │   ├── configuration.nix              # NixOS config importing shared modules
│   │   └── my-config.nix                  # Host-specific overrides (hostname, user, proj)
│   ├── example/                           # Templates for new GCP VMs
│   │   ├── configuration.nix              # Template NixOS config
│   │   └── my-config.nix                  # Template host config with placeholders
│   ├── firewall.ts                        # Firewall rules (IAP SSH, tailscale, deny-all)
│   ├── iam.ts                             # IAM bindings for IAP and compute permissions
│   ├── index.ts                           # Pulumi entrypoint exporting all resources/outputs
│   ├── install-nixos.sh*                  # Executable: automated NixOS install via IAP/SSH
│   ├── monitoring.ts                      # Logging metrics + alert policies (security/events)
│   └── network.ts                         # VPC, subnets, Cloud NAT, flow logs
├── GCP-USAGE.md                           # Human guide for provisioning/operating GCP VM(s)
├── mac/                                   # macOS (nix-darwin) configuration
│   └── cyan/                              # Host config for 'cyan' MacBook Pro
│       ├── configuration.nix              # nix-darwin system configuration
│       └── packages.nix                   # macOS package selections
├── mise.toml                              # mise tasks, tool versions, env vars
├── modules/                               # Shared NixOS modules used by hosts
│   ├── core.nix                           # Base system config + essential packages
│   ├── disko-partitions.nix               # Disk layout (EFI, swap, ext4 root) via disko
│   ├── golang.nix                         # Optional Go dev environment module
│   ├── nh.nix                             # NixOS Helper (nh) + build output tooling
│   ├── nix.nix                            # Nix daemon, GC, substituters/caches
│   ├── openssh-server.nix                 # Hardened OpenSSH server configuration
│   ├── security.nix                       # Firewall, fail2ban, polkit rules
│   ├── tailscale.nix                      # Tailscale VPN + SSH integration
│   ├── user.nix                           # User accounts, SSH keys, shell, sudo
│   └── vector.nix                         # Vector agent → Google Cloud Logging
├── package.json                           # JS/TS manifest (Pulumi code, scripts)
├── packages/                              # Custom Nix packages/overlays (derivations)
├── Pulumi.coral.yaml                      # Pulumi stack config for 'coral' environment
├── Pulumi.example.yaml                    # Template Pulumi stack config for new VMs
├── Pulumi.yaml                            # Pulumi project manifest (name, runtime)
├── secrets/                               # SOPS-encrypted secrets
│   ├── gcp_coral.yaml                     # Secrets for 'coral' (password hashes, tailscale)
│   └── gcp_example.yaml                   # Template secrets for new VM stacks
├── stylua.toml                            # StyLua formatter config (Lua files)
├── tests/                                 # Test suites
│   └── gcp/
│       └── install-nixos-test.sh          # bashunit tests for installer script
└── tsconfig.json                          # TypeScript compiler configuration
```
## How to reuse some of this config

Aside from this README.md, the other main docs are:
- CLAUDE.md : detailed instructions for AI coding agents to understand this repository. Humans may find it useful too
- GCP-USAGE.md : explains how to create a new Pulumi Stack and a set of GCP resources for a new GCP virtual machine running NixOS

# FAQs

## What are the hostnames of machines managed here?

- Currently, this repo contains config for:
    - A GCP VM named `coral` in ./gcp/coral/configuration.nix
    - A MacBook Pro named `cyan` in ./mac/cyan/configuration.nix

## Why don't you run NixOS in a VM on macOS?

I tried it already and didn't like it, Specifically, I tried running NixOS in a VM in VMWare Fusion and Parallels.

Although it worked, I realized that I prefer the simplicity of using nix-darwin on macOS. There seemed to be too many bugs and workarounds needed to make Parallels Tools or VMWare Tools properly.

## Why don't you use Home Manager?

[Home Manager](https://github.com/nix-community/home-manager) adds another layer of unnecessary complexity for me. I can't remember all of the Nix options specific to Home Manager. And althought I could, I just don't want to spend unnecessary time reading through the Nix configuration in Home Manager.

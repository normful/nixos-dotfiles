#!/usr/bin/env bash

set -o errexit
set -o pipefail

main() {
    if ! git ls-files >& /dev/null; then
        echo "Error: This script must be run within a git repository."
        exit 1
    fi

    if ! git diff --cached --quiet; then
        # Use staged files
        :
    else
        git add -A
    fi

    if [[ -n "$OCO_API_KEY" ]]; then
        # Check if there are many changes
        change_count=$(git diff --cached --numstat | wc -l)
        if [[ $change_count -gt 20 ]]; then
            git commit -m "no auto-generated commit message (large commit)"
        else
            opencommit --yes
        fi
    else
        git commit -m "wip"
    fi
}

main "$@"
